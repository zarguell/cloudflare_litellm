name: Test LiteLLM via Cloudflare Access (hardened)

on:
  workflow_dispatch:  # Manual trigger for testing

jobs:
  test-litellm-access:
    runs-on: ubuntu-latest

    steps:
    - name: Harden the runner (egress audit only)
      uses: step-security/harden-runner@c6295a65d1254861815972266d5933fd6e532bdf # v2.11.1
      with:
        egress-policy: audit

    # - name: Test LiteLLM health endpoint
    #   env:
    #     LITELLM_HOST: ${{ secrets.LITELLM_HOST }}
    #     LITELLM_API_KEY: ${{ secrets.LITELLM_API_KEY }}
    #     CF_ACCESS_CLIENT_ID: ${{ secrets.CF_ACCESS_CLIENT_ID }}
    #     CF_ACCESS_CLIENT_SECRET: ${{ secrets.CF_ACCESS_CLIENT_SECRET }}
    #   run: |
    #     set -e
    #     echo "ðŸ§ª Testing LiteLLM health via Cloudflare Access..."
    #     RESPONSE="$(curl -ksS -w '\n%{http_code}' \
    #       -H "CF-Access-Client-Id: $CF_ACCESS_CLIENT_ID" \
    #       -H "CF-Access-Client-Secret: $CF_ACCESS_CLIENT_SECRET" \
    #       -H "Authorization: Bearer $LITELLM_API_KEY" \
    #       https://$LITELLM_HOST/health || true)"
    #     HTTP_CODE="$(echo "$RESPONSE" | tail -n1)"
    #     BODY="$(echo "$RESPONSE" | head -n-1)"

    #     echo "HTTP status: $HTTP_CODE"
    #     echo "Body: $BODY"

    #     if [ "$HTTP_CODE" != "200" ]; then
    #       echo "âŒ Health check failed"
    #       exit 1
    #     fi
    #     echo "âœ… Health check OK"

    - name: Test simple LiteLLM chat completion
      env:
        LITELLM_HOST: ${{ secrets.LITELLM_HOST }}
        LITELLM_API_KEY: ${{ secrets.LITELLM_API_KEY }}
        CF_ACCESS_CLIENT_ID: ${{ secrets.CF_ACCESS_CLIENT_ID }}
        CF_ACCESS_CLIENT_SECRET: ${{ secrets.CF_ACCESS_CLIENT_SECRET }}
      run: |
        set -e
        echo "ðŸš€ Testing LiteLLM /v1/chat/completions via Cloudflare Access..."
        curl -ksS -X POST "https://$LITELLM_HOST/v1/chat/completions" \
          -H "Content-Type: application/json" \
          -H "CF-Access-Client-Id: $CF_ACCESS_CLIENT_ID" \
          -H "CF-Access-Client-Secret: $CF_ACCESS_CLIENT_SECRET" \
          -H "Authorization: Bearer $LITELLM_API_KEY" \
          -d '{
            "model": "gpt-4",
            "messages": [
              {"role": "user", "content": "Say hello in one short sentence."}
            ],
            "max_tokens": 16
          }' | tee response.json

        if grep -q '"choices"' response.json; then
          echo "âœ… LiteLLM responded successfully"
        else
          echo "âŒ LiteLLM response did not contain choices"
          cat response.json
          exit 1
        fi

    - name: Summary
      if: always()
      run: |
        echo "## ðŸ” Hardened LiteLLM Connectivity Test (Cloudflare)" >> $GITHUB_STEP_SUMMARY
        echo "- StepSecurity Harden-Runner: enabled (egress audit)" >> $GITHUB_STEP_SUMMARY
        echo "- Cloudflare Access service token: see logs above" >> $GITHUB_STEP_SUMMARY
        echo "- LiteLLM API key authentication: see logs above" >> $GITHUB_STEP_SUMMARY
        echo "- LiteLLM health + simple chat: see logs above" >> $GITHUB_STEP_SUMMARY
